generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum AccountRole {
  OWNER
  MANAGER
  USER
}

model User {
  id            String   @id
  name          String
  email         String
  emailVerified Boolean  @default(false)
  image         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Account-level
  accountRole     AccountRole @default(USER)
  mainWorkspaceId String?

  // Account ownership - who owns this user's account
  // null means user is their own account owner
  accountOwnerId String?
  accountOwner   User?   @relation("AccountMembers", fields: [accountOwnerId], references: [id], onDelete: SetNull)
  accountMembers User[]  @relation("AccountMembers")

  // ... existing relations
  sessions         Session[]
  accounts         Account[]
  workspaces       Workspace[]   @relation("CreatedWorkspaces")
  createdWorkflows Workflow[]
  members          Member[]
  sentInvitations  Invitation[]  @relation("SentInvitations")
  mainWorkspace    Workspace?    @relation("MainWorkspace", fields: [mainWorkspaceId], references: [id], onDelete: SetNull)
  assignedTasks    Task[]
  assignedContacts ChatContact[] @relation("AssignedContacts")
  domains          Domain[]
  twilioConfig     TwilioConfig?
  stages           Stage[]
  campaigns        Campaign[]
  campaignSequences CampaignSequence[]
  emailTemplates   EmailTemplate[]
  campaignGroups   CampaignGroup[]
  campaignTemplates CampaignTemplate[]
  savedSegments     SavedSegment[]

  @@unique([email])
  @@index([accountOwnerId])
  @@map("user")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@index([userId])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
  @@map("verification")
}

model Workspace {
  id             String   @id @default(cuid())
  name           String
  imageUrl       String?
  inviteCode     String   @unique
  webhookSecret  String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  userId     String // original creator/owner

  // Google Business Profile data
  googlePlaceId       String?
  address             String?
  city                String?
  state               String?
  zipCode             String?
  country             String    @default("US")
  phone               String?
  website             String?
  latitude            Float?
  longitude           Float?
  timezone            String?
  primaryCategory     String?
  secondaryCategories String[]  @default([])
  googleRating        Float?
  googleReviewCount   Int?
  scrapedPlaceData    Json?
  scrapedCompetitors  Json?
  lastScrapedAt       DateTime?

  // Location context for chatbot AI
  description     String? @db.Text
  paymentLink     String?
  feedbackSlug    String? @unique // short code for /r/[slug]
  googleReviewUrl String? // direct Google review link
  feedbackHeading String? // "How was your experience?"
  feedbackMessage String? @db.Text // optional subtext

  members        Member[]
  workflows      Workflow[]
  invitations    Invitation[]
  usersWithMain  User[]          @relation("MainWorkspace")
  taskColumns    TaskColumn[]
  tasks          Task[]
  reports        Report[]
  reviews        Review[]
  feedbackVisits FeedbackVisit[]

  // Chatbot relations (conversations routed to workspace)
  chatContacts ChatContact[]
  chatRooms    ChatRoom[]
  domains      Domain[]
  categories   Category[]
  activities   Activity[]
  campaigns    Campaign[]
  sequences    CampaignSequence[]
  textToJoinKeywords TextToJoinKeyword[]
  webhookEndpoints WebhookEndpoint[]

  twilioPhoneNumber TwilioPhoneNumber?
  smsMessages       SmsMessage[]
  fromEmail         String?
  fromEmailName     String?

  user User @relation("CreatedWorkspaces", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("workspace")
}

model Stage {
  id          String    @id @default(cuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  name        String
  slug        String
  color       String    @default("slate")
  order       Int       @default(0)
  createdAt   DateTime  @default(now())

  @@unique([userId, slug])
  @@map("stage")
}

model FeedbackVisit {
  id           String   @id @default(cuid())
  workspaceId  String
  path         String // "review" | "feedback"
  contactPhone String? // if we know who clicked
  createdAt    DateTime @default(now())

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([workspaceId, createdAt])
  @@map("feedback_visit")
}

model Domain {
  id          String  @id @default(cuid())
  userId      String
  name        String
  icon        String?
  workspaceId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace Workspace? @relation(fields: [workspaceId], references: [id], onDelete: SetNull)

  // Chatbot relations
  chatBot         ChatBot?
  helpDeskItems   HelpDeskItem[]
  filterQuestions FilterQuestion[]
  chatContacts    ChatContact[]
  chatRooms       ChatRoom[]

  @@unique([userId, name])
  @@index([userId])
  @@index([workspaceId])
  @@map("domain")
}

enum MemberRole {
  ADMIN
  MEMBER
}

model Member {
  id          String     @id @default(cuid())
  userId      String
  workspaceId String
  role        MemberRole @default(MEMBER)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([userId, workspaceId])
  @@index([userId])
  @@index([workspaceId])
  @@map("member")
}

model Workflow {
  id          String   @id @default(cuid())
  name        String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  workspaceId String
  createdById String

  nodes       Node[]
  connections Connection[]
  executions  Execution[]

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  createdBy User      @relation(fields: [createdById], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([createdById])
  @@map("workflow")
}

enum NodeType {
  INITIAL
  MANUAL_TRIGGER
  HTTP_REQUEST
  GOOGLE_FORM_TRIGGER
  STRIPE_TRIGGER
  GROK
  GEMINI
  OPENAI
  SLACK
}

model Node {
  id         String   @id @default(cuid())
  workflowId String
  workflow   Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  name     String
  type     NodeType
  position Json
  data     Json     @default("{}")

  outputConnections Connection[] @relation("FromNode")
  inputConnections  Connection[] @relation("ToNode")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([workflowId])
  @@map("node")
}

model Connection {
  id         String   @id @default(cuid())
  workflowId String
  workflow   Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  fromNodeId String
  fromNode   Node   @relation("FromNode", fields: [fromNodeId], references: [id], onDelete: Cascade)
  toNodeId   String
  toNode     Node   @relation("ToNode", fields: [toNodeId], references: [id], onDelete: Cascade)

  fromOutput String @default("main")
  toInput    String @default("main")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([fromNodeId, toNodeId, fromOutput, toInput])
  @@index([workflowId])
  @@map("connection")
}

enum ExecutionStatus {
  RUNNING
  SUCCESS
  FAILED
}

model Execution {
  id String @id @default(cuid())

  workflowId String
  workflow   Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  status     ExecutionStatus @default(RUNNING)
  error      String?         @db.Text
  errorStack String?         @db.Text

  startedAt  DateTime  @default(now())
  completeAt DateTime?

  inngestEventId String @unique

  output Json?

  @@index([workflowId])
  @@map("execution")
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
}

model Invitation {
  id          String           @id @default(cuid())
  email       String
  workspaceId String
  role        MemberRole       @default(MEMBER)
  invitedById String
  status      InvitationStatus @default(PENDING)
  expiresAt   DateTime?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  invitedBy User      @relation("SentInvitations", fields: [invitedById], references: [id], onDelete: Cascade)

  @@unique([email, workspaceId])
  @@index([email])
  @@index([workspaceId])
  @@map("invitation")
}

model TaskColumn {
  id          String   @id @default(cuid())
  workspaceId String
  name        String
  color       String   @default("#6B7280")
  position    Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  tasks     Task[]

  @@unique([workspaceId, position])
  @@index([workspaceId])
  @@map("task_column")
}

model Task {
  id          String    @id @default(cuid())
  workspaceId String
  columnId    String
  assigneeId  String?
  contactId   String?
  taskNumber  Int
  name        String
  description String?   @db.Text
  position    Int       @default(1000)
  dueDate     DateTime?
  startDate   DateTime?
  category    String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  reviewId    String?

  workspace Workspace  @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  column    TaskColumn @relation(fields: [columnId], references: [id], onDelete: Cascade)
  assignee  User?      @relation(fields: [assigneeId], references: [id], onDelete: SetNull)
  contact   ChatContact? @relation(fields: [contactId], references: [id], onDelete: SetNull)
  review    Review?    @relation(fields: [reviewId], references: [id], onDelete: SetNull)

  @@unique([workspaceId, taskNumber])
  @@index([workspaceId])
  @@index([columnId])
  @@index([assigneeId])
  @@index([contactId])
  @@index([reviewId])
  @@map("task")
}

// =============================================
// SEO/GEO Report Tool
// =============================================

enum ReportStatus {
  PENDING
  FETCHING
  ANALYZING
  COMPLETED
  FAILED
}

model Report {
  id          String @id @default(cuid())
  workspaceId String

  status ReportStatus @default(PENDING)

  // Top-level scores (0-100)
  visibilityScore Float?
  reputationScore Float?

  // Detailed breakdowns (Zod-validated JSON)
  visibilityBreakdown Json?
  reputationBreakdown Json?

  // AI-generated insights (Zod-validated JSON)
  strengths       Json?
  weaknesses      Json?
  recommendations Json?

  // Raw API response data (enables smart retry without re-fetching)
  rawData Json?

  // Verification: did Outscraper match the workspace address?
  verification Json?

  // Map pack competitors snapshot
  competitors Json?

  error String? @db.Text

  createdAt   DateTime  @default(now())
  completedAt DateTime?

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([workspaceId, createdAt])
  @@map("report")
}

// =============================================
// Reviews
// =============================================

model Review {
  id          String    @id @default(cuid())
  workspaceId String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  tasks       Task[]

  // Google identity (for dedup on re-scrape)
  googleReviewId String?
  authorName     String?
  authorUrl      String?
  authorImageUrl String?

  // Core review data
  rating      Float
  text        String?   @db.Text
  publishedAt DateTime?

  // Owner response tracking
  ownerResponse    String?   @db.Text
  ownerRespondedAt DateTime?

  // Metadata
  source   String  @default("google") // google, yelp, facebook later
  language String?

  // Sync tracking
  firstSeenAt  DateTime @default(now())
  lastSyncedAt DateTime @default(now())

  // Performance indexes
  @@unique([workspaceId, googleReviewId]) // Prevents duplicate reviews
  @@index([workspaceId, publishedAt]) // Sort by date (paginated list)
  @@index([workspaceId, rating]) // Filter by star rating
  @@index([workspaceId, source]) // Filter by platform
  @@map("review")
}

// =============================================
// Chatbot System
// =============================================

model ChatBot {
  id       String @id @default(cuid())
  domainId String @unique

  // Widget appearance
  welcomeMessage    String? @default("Hi, how can we assist you today?")
  icon              String?
  headerText        String? @default("Sales Rep")
  themeColor        String? @default("#14b8a6")
  businessContext   String?
  bubbleTransparent Boolean @default(false)

  // Behavior
  helpdesk Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  domain Domain @relation(fields: [domainId], references: [id], onDelete: Cascade)

  @@index([domainId])
  @@map("chatbot")
}

model HelpDeskItem {
  id       String @id @default(cuid())
  domainId String
  question String
  answer   String @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  domain Domain @relation(fields: [domainId], references: [id], onDelete: Cascade)

  @@index([domainId])
  @@map("help_desk_item")
}

model FilterQuestion {
  id       String @id @default(cuid())
  domainId String
  question String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  domain    Domain                @relation(fields: [domainId], references: [id], onDelete: Cascade)
  responses ChatContactResponse[]

  @@index([domainId])
  @@map("filter_question")
}

model ChatContact {
  id          String @id @default(cuid())
  workspaceId String
  domainId    String?

  // Identity
  firstName String?
  lastName  String?
  email     String?
  phone     String?
  imageUrl  String?

  // CRM
  stage           String    @default("new_lead") // new_lead, prospecting, appointment, payment, not_a_fit, lost
  source          String    @default("manual") // manual, csv, webhook, chatbot, sms, feedback, review_campaign
  notes           String?   @db.Text
  assignedToId    String?
  lastContactedAt DateTime?
  isContact       Boolean   @default(false)
  optedOut        Boolean   @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  domain    Domain?   @relation(fields: [domainId], references: [id], onDelete: Cascade)
  assignedTo User?    @relation("AssignedContacts", fields: [assignedToId], references: [id], onDelete: SetNull)
  responses ChatContactResponse[]
  chatRooms ChatRoom[]
  categories ContactCategory[]
  activities Activity[]
  tasks      Task[]
  campaignRecipients CampaignRecipient[]
  enrollments CampaignSequenceEnrollment[]

  @@index([workspaceId])
  @@unique([workspaceId, phone])
  @@index([workspaceId, email])
  @@index([workspaceId, stage])
  @@index([assignedToId])
  @@map("chat_contact")
}

model Campaign {
  id                  String    @id @default(cuid())
  workspaceId         String
  workspace           Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  createdById         String
  createdBy           User      @relation(fields: [createdById], references: [id])
  groupId             String?
  group               CampaignGroup? @relation(fields: [groupId], references: [id], onDelete: SetNull)
  name                String
  channel             String    @default("sms")
  messageTemplate     String
  subject             String?

  // V2: Template + Segment links
  templateId          String?
  template            CampaignTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  segmentId           String?
  segment             SavedSegment?     @relation(fields: [segmentId], references: [id], onDelete: SetNull)

  // Audience config
  audienceType        String    @default("all") // all, stage, category, inactive
  audienceStage       String?
  audienceCategoryId  String?
  audienceInactiveDays Int?
  frequencyCapDays    Int?      // skip contacts messaged in last X days

  status              String    @default("draft") // draft, scheduled, sending, paused, completed, cancelled
  scheduledAt         DateTime?
  startedAt           DateTime?
  completedAt         DateTime?

  // Stats
  totalRecipients     Int       @default(0)
  sentCount           Int       @default(0)
  deliveredCount      Int       @default(0)
  failedCount         Int       @default(0)
  repliedCount        Int       @default(0)
  variantB            String?   @db.Text
  variantSplit        Int       @default(50)
  variantASent        Int       @default(0)
  variantADelivered   Int       @default(0)
  variantAReplied     Int       @default(0)
  variantBSent        Int       @default(0)
  variantBDelivered   Int       @default(0)
  variantBReplied     Int       @default(0)

  // V2: Recurring
  recurringType       String?
  recurringDay        Int?
  recurringTime       String?
  recurringEndAt      DateTime?
  lastRecurredAt      DateTime?

  // V3: Recurring parent link
  parentCampaignId    String?
  parentCampaign      Campaign?  @relation("RecurringChildren", fields: [parentCampaignId], references: [id], onDelete: SetNull)
  childCampaigns      Campaign[] @relation("RecurringChildren")
  autoReply           CampaignAutoReply?
  autoReplyLogs       CampaignAutoReplyLog[]
  links               CampaignLink[]
  unsubscribeLink     Boolean    @default(false)

  // V2: Business hours
  sendWindowStart     String?
  sendWindowEnd       String?

  recipients          CampaignRecipient[]
  emailSends          EmailSend[]
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@index([workspaceId])
  @@index([createdById])
  @@index([groupId])
  @@index([templateId])
  @@index([segmentId])
  @@index([recurringType])
  @@index([parentCampaignId])
  @@index([status])
  @@map("campaign")
}

model CampaignAutoReply {
  id          String   @id @default(cuid())
  campaignId  String
  campaign    Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  enabled     Boolean  @default(false)
  tone        String   @default("friendly")
  context     String?  @db.Text
  maxReplies  Int      @default(1)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([campaignId])
  @@map("campaign_auto_reply")
}

model CampaignLink {
  id          String   @id @default(cuid())
  campaignId  String
  campaign    Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  originalUrl String
  shortCode   String   @unique
  clickCount  Int      @default(0)

  clicks      CampaignLinkClick[]
  createdAt   DateTime @default(now())

  @@index([campaignId])
  @@map("campaign_link")
}

model CampaignLinkClick {
  id          String             @id @default(cuid())
  linkId      String
  link        CampaignLink       @relation(fields: [linkId], references: [id], onDelete: Cascade)
  recipientId String?
  recipient   CampaignRecipient? @relation(fields: [recipientId], references: [id], onDelete: SetNull)

  ip          String?
  userAgent   String?
  createdAt   DateTime @default(now())

  @@index([linkId])
  @@index([recipientId])
  @@map("campaign_link_click")
}

model CampaignAutoReplyLog {
  id             String            @id @default(cuid())
  recipientId    String
  recipient      CampaignRecipient @relation(fields: [recipientId], references: [id], onDelete: Cascade)
  campaignId     String
  campaign       Campaign          @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  contactId      String

  inboundMessage String            @db.Text
  aiResponse     String            @db.Text
  tone           String

  createdAt      DateTime          @default(now())

  @@index([recipientId])
  @@index([campaignId])
  @@map("campaign_auto_reply_log")
}

model CampaignGroup {
  id          String     @id @default(cuid())
  createdById String
  createdBy   User       @relation(fields: [createdById], references: [id])
  name        String
  campaigns   Campaign[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([createdById])
  @@map("campaign_group")
}

model CampaignTemplate {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  name      String
  category  String   @default("custom")
  channel   String   @default("sms")
  subject   String?
  body      String   @db.Text
  isLibrary Boolean  @default(false)

  campaigns Campaign[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([category])
  @@index([isLibrary])
  @@map("campaign_template")
}

model SavedSegment {
  id                   String   @id @default(cuid())
  userId               String
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  name                 String
  audienceType         String   @default("all")
  audienceStage        String?
  audienceCategoryId   String?
  audienceInactiveDays Int?
  frequencyCapDays     Int?

  campaigns            Campaign[]
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@index([userId])
  @@map("saved_segment")
}

model CampaignRecipient {
  id           String      @id @default(cuid())
  campaignId   String
  campaign     Campaign    @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  contactId    String
  contact      ChatContact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  status       String    @default("pending") // pending, sent, delivered, failed, replied, opted_out
  sentAt       DateTime?
  deliveredAt  DateTime?
  failedAt     DateTime?
  repliedAt    DateTime?
  errorMessage String?
  smsMessageId String?
  variant      String?
  aiRepliesSent Int       @default(0)
  linkClicks    CampaignLinkClick[]
  autoReplyLogs CampaignAutoReplyLog[]
  emailSends    EmailSend[]

  createdAt    DateTime  @default(now())

  @@unique([campaignId, contactId])
  @@index([campaignId, status])
  @@index([contactId])
  @@map("campaign_recipient")
}

model CampaignSequence {
  id                  String     @id @default(cuid())
  workspaceId         String
  workspace           Workspace  @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  createdById         String
  createdBy           User       @relation(fields: [createdById], references: [id])

  name                String
  description         String?    @db.Text
  status              String     @default("draft") // draft, active, paused, archived

  // Audience (same pattern as campaigns)
  audienceType        String     @default("all")
  audienceStage       String?
  audienceCategoryId  String?
  audienceInactiveDays Int?
  frequencyCapDays    Int?

  // Trigger
  triggerType         String     @default("manual") // manual, contact_created, keyword_join, stage_change
  triggerValue        String? // e.g. keyword id, stage slug

  steps               CampaignSequenceStep[]
  enrollments         CampaignSequenceEnrollment[]

  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  @@index([workspaceId])
  @@index([status])
  @@map("campaign_sequence")
}

model CampaignSequenceStep {
  id               String           @id @default(cuid())
  sequenceId       String
  sequence         CampaignSequence @relation(fields: [sequenceId], references: [id], onDelete: Cascade)

  order            Int
  channel          String           @default("sms") // sms, email
  subject          String? // email only
  body             String           @db.Text
  templateId       String?

  // Delay before this step (from previous step or enrollment)
  delayMinutes     Int              @default(0)

  // Conditions to skip/branch
  conditionType    String? // replied, clicked, no_reply, opted_out
  conditionAction  String           @default("continue") // continue, skip, stop

  // Business hours
  sendWindowStart  String?
  sendWindowEnd    String?

  stepLogs         CampaignSequenceStepLog[]

  createdAt        DateTime         @default(now())

  @@index([sequenceId, order])
  @@map("campaign_sequence_step")
}

model CampaignSequenceEnrollment {
  id              String                 @id @default(cuid())
  sequenceId      String
  sequence        CampaignSequence       @relation(fields: [sequenceId], references: [id], onDelete: Cascade)
  contactId       String
  contact         ChatContact            @relation(fields: [contactId], references: [id], onDelete: Cascade)

  status          String                 @default("active") // active, completed, stopped, opted_out
  currentStep     Int                    @default(0)
  nextStepAt      DateTime?

  enrolledAt      DateTime               @default(now())
  completedAt     DateTime?
  stoppedAt       DateTime?
  stoppedReason   String?

  stepLogs        CampaignSequenceStepLog[]

  @@unique([sequenceId, contactId])
  @@index([sequenceId, status])
  @@index([contactId])
  @@index([nextStepAt])
  @@map("campaign_sequence_enrollment")
}

model CampaignSequenceStepLog {
  id             String                     @id @default(cuid())
  enrollmentId   String
  enrollment     CampaignSequenceEnrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  stepId         String
  step           CampaignSequenceStep       @relation(fields: [stepId], references: [id], onDelete: Cascade)

  status         String // sent, delivered, failed, skipped
  channel        String
  messageId      String? // Twilio SID or email provider ID
  sentAt         DateTime?
  deliveredAt    DateTime?
  repliedAt      DateTime?
  failedAt       DateTime?
  errorMessage   String?
  skippedReason  String?

  createdAt      DateTime                   @default(now())

  @@index([enrollmentId])
  @@index([stepId])
  @@map("campaign_sequence_step_log")
}

model EmailTemplate {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id])

  name         String
  subject      String
  htmlBody     String   @db.Text
  textBody     String?  @db.Text // plain text fallback
  category     String   @default("custom")
  isLibrary    Boolean  @default(false)

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([userId, name])
  @@index([userId, category])
  @@map("email_template")
}

model EmailSend {
  id           String              @id @default(cuid())
  campaignId   String?
  campaign     Campaign?           @relation(fields: [campaignId], references: [id], onDelete: SetNull)
  recipientId  String?
  recipient    CampaignRecipient?  @relation(fields: [recipientId], references: [id], onDelete: SetNull)
  contactId    String
  workspaceId  String

  toEmail      String
  fromEmail    String
  fromName     String?
  subject      String
  providerId   String? // Resend message ID

  status       String   @default("pending") // pending, sent, delivered, opened, clicked, bounced, complained
  openCount    Int      @default(0)
  clickCount   Int      @default(0)

  sentAt       DateTime?
  deliveredAt  DateTime?
  openedAt     DateTime?
  bouncedAt    DateTime?

  createdAt    DateTime @default(now())

  @@index([campaignId])
  @@index([contactId])
  @@index([workspaceId])
  @@index([providerId])
  @@map("email_send")
}

model WebhookEndpoint {
  id           String            @id @default(cuid())
  workspaceId  String
  workspace    Workspace         @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  url          String
  secret       String // HMAC signing secret
  events       String[] // campaign.sent, contact.replied, etc.
  active       Boolean           @default(true)

  lastStatus   Int? // last HTTP status code
  lastError    String?
  lastFiredAt  DateTime?
  failCount    Int               @default(0)

  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt

  deliveries   WebhookDelivery[]

  @@index([workspaceId])
  @@map("webhook_endpoint")
}

model WebhookDelivery {
  id            String          @id @default(cuid())
  endpointId    String
  endpoint      WebhookEndpoint @relation(fields: [endpointId], references: [id], onDelete: Cascade)

  event         String
  payload       String          @db.Text // JSON
  status        Int? // HTTP response code
  responseBody  String?         @db.Text
  duration      Int? // ms
  error         String?

  attemptCount  Int             @default(1)
  nextRetryAt   DateTime?

  createdAt     DateTime        @default(now())

  @@index([endpointId])
  @@index([nextRetryAt])
  @@map("webhook_delivery")
}

model TextToJoinKeyword {
  id           String    @id @default(cuid())
  workspaceId  String
  workspace    Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  keyword      String
  autoReply    String    @db.Text
  stage        String    @default("new_lead")
  categoryId   String?
  source       String    @default("text_to_join")

  contactCount Int       @default(0)
  active       Boolean   @default(true)

  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@unique([workspaceId, keyword])
  @@index([workspaceId])
  @@map("text_to_join_keyword")
}

model Category {
  id          String @id @default(cuid())
  workspaceId String
  name        String
  color       String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  workspace Workspace         @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  contacts  ContactCategory[]

  @@unique([workspaceId, name])
  @@index([workspaceId])
  @@map("category")
}

model ContactCategory {
  id         String @id @default(cuid())
  contactId  String
  categoryId String

  contact  ChatContact @relation(fields: [contactId], references: [id], onDelete: Cascade)
  category Category    @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([contactId, categoryId])
  @@index([contactId])
  @@index([categoryId])
  @@map("contact_category")
}

model Activity {
  id          String @id @default(cuid())
  contactId   String
  workspaceId String
  type        String // sms_sent, sms_received, chatbot_session, review_requested, review_received, task_created, stage_changed, note_added, feedback_submitted, contact_created, contact_updated
  description String
  metadata    Json?

  createdAt DateTime @default(now())

  contact   ChatContact @relation(fields: [contactId], references: [id], onDelete: Cascade)
  workspace Workspace   @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([contactId])
  @@index([contactId, createdAt])
  @@index([workspaceId])
  @@map("activity")
}

model ChatContactResponse {
  id         String  @id @default(cuid())
  contactId  String
  questionId String
  answer     String?

  createdAt DateTime @default(now())

  contact  ChatContact    @relation(fields: [contactId], references: [id], onDelete: Cascade)
  question FilterQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@index([contactId])
  @@index([questionId])
  @@map("chat_contact_response")
}

enum ChatMessageRole {
  USER
  ASSISTANT
}

model ChatRoom {
  id          String  @id @default(cuid())
  domainId    String?
  workspaceId String?
  contactId   String?

  live   Boolean @default(false)
  mailed Boolean @default(false)

  channel String @default("webchat") // "webchat" | "sms" | "email"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  domain      Domain?       @relation(fields: [domainId], references: [id], onDelete: Cascade)
  workspace   Workspace?    @relation(fields: [workspaceId], references: [id], onDelete: SetNull)
  contact     ChatContact?  @relation(fields: [contactId], references: [id], onDelete: SetNull)
  messages    ChatMessage[]
  smsMessages SmsMessage[]

  @@index([domainId])
  @@index([workspaceId])
  @@index([contactId])
  @@index([domainId, createdAt])
  @@map("chat_room")
}

model ChatMessage {
  id         String          @id @default(cuid())
  chatRoomId String
  message    String          @db.Text
  role       ChatMessageRole
  seen       Boolean         @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  chatRoom ChatRoom @relation(fields: [chatRoomId], references: [id], onDelete: Cascade)

  @@index([chatRoomId])
  @@index([chatRoomId, createdAt])
  @@map("chat_message")
}

// =============================================
// Twilio / Messaging
// =============================================

model TwilioConfig {
  id                  String  @id @default(cuid())
  userId              String  @unique
  subaccountSid       String
  subaccountToken     String
  friendlyName        String?
  messagingServiceSid String?
  verificationStatus  String  @default("pending") // pending | approved

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("twilio_config")
}

model TwilioPhoneNumber {
  id           String  @id @default(cuid())
  workspaceId  String  @unique
  phoneNumber  String // e.g. +15551234567
  phoneSid     String? // Twilio Phone Number SID (PN...)
  friendlyName String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@map("twilio_phone_number")
}

enum SmsStatus {
  QUEUED
  SENT
  DELIVERED
  UNDELIVERED
  FAILED
}

model SmsMessage {
  id          String    @id @default(cuid())
  workspaceId String
  chatRoomId  String? // links to conversation if part of a thread
  direction   String // "inbound" | "outbound"
  from        String // phone number
  to          String // phone number
  body        String    @db.Text
  mediaUrl    String?
  twilioSid   String?   @unique // Twilio Message SID
  status      SmsStatus @default(QUEUED)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  chatRoom  ChatRoom? @relation(fields: [chatRoomId], references: [id], onDelete: SetNull)

  @@index([workspaceId])
  @@index([chatRoomId])
  @@index([twilioSid])
  @@index([workspaceId, createdAt])
  @@map("sms_message")
}
