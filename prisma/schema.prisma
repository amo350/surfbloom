generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum AccountRole {
  OWNER
  MANAGER
  USER
}

model User {
  id               String       @id
  name             String
  email            String
  emailVerified    Boolean      @default(false)
  image            String?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  // Account-level
  accountRole      AccountRole  @default(USER)
  mainWorkspaceId  String?

  // Account ownership - who owns this user's account
  // null means user is their own account owner
  accountOwnerId   String?
  accountOwner     User?        @relation("AccountMembers", fields: [accountOwnerId], references: [id], onDelete: SetNull)
  accountMembers   User[]       @relation("AccountMembers")

  // ... existing relations
  sessions         Session[]
  accounts         Account[]
  workspaces       Workspace[]  @relation("CreatedWorkspaces")
  createdWorkflows Workflow[]
  members          Member[]
  sentInvitations  Invitation[] @relation("SentInvitations")
  mainWorkspace    Workspace?   @relation("MainWorkspace", fields: [mainWorkspaceId], references: [id], onDelete: SetNull)
  assignedTasks    Task[]
  domains          Domain[]

  @@unique([email])
  @@index([accountOwnerId])
  @@map("user")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@index([userId])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@index([userId])
  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
  @@map("verification")
}

model Workspace {
  id         String   @id @default(cuid())
  name       String
  imageUrl   String?
  inviteCode String   @unique
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  userId     String   // original creator/owner

  // Google Business Profile data
  googlePlaceId       String?
  address             String?
  city                String?
  state               String?
  zipCode             String?
  country             String   @default("US")
  phone               String?
  website             String?
  latitude            Float?
  longitude           Float?
  timezone            String?
  primaryCategory     String?
  secondaryCategories String[] @default([])
  googleRating        Float?
  googleReviewCount   Int?
  scrapedPlaceData    Json?
  scrapedCompetitors  Json?
  lastScrapedAt       DateTime?

  members         Member[]
  workflows       Workflow[]
  invitations     Invitation[]
  usersWithMain   User[]           @relation("MainWorkspace")
  taskColumns     TaskColumn[]
  tasks           Task[]
  reports         Report[]
  reviews         Review[]

  // Chatbot relations (conversations routed to workspace)
  chatContacts    ChatContact[]
  chatRooms       ChatRoom[]
  domains         Domain[]

  user       User @relation("CreatedWorkspaces", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("workspace")
}

model Domain {
  id          String     @id @default(cuid())
  userId      String
  name        String
  icon        String?
  workspaceId String?

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace   Workspace? @relation(fields: [workspaceId], references: [id], onDelete: SetNull)

  // Chatbot relations
  chatBot         ChatBot?
  helpDeskItems   HelpDeskItem[]
  filterQuestions  FilterQuestion[]
  chatContacts    ChatContact[]
  chatRooms       ChatRoom[]

  @@unique([userId, name])
  @@index([userId])
  @@index([workspaceId])
  @@map("domain")
}

enum MemberRole {
  ADMIN
  MEMBER
}

model Member {
  id          String     @id @default(cuid())
  userId      String
  workspaceId String
  role        MemberRole @default(MEMBER)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace   Workspace  @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([userId, workspaceId])
  @@index([userId])
  @@index([workspaceId])
  @@map("member")
}

model Workflow {
  id          String   @id @default(cuid())
  name        String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  workspaceId String
  createdById String

  nodes       Node[]
  connections Connection[]
  executions  Execution[]

  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  createdBy   User      @relation(fields: [createdById], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([createdById])
  @@map("workflow")
}

enum NodeType {
  INITIAL
  MANUAL_TRIGGER
  HTTP_REQUEST
  GOOGLE_FORM_TRIGGER
  STRIPE_TRIGGER
  GROK
  GEMINI
  OPENAI
  SLACK
}

model Node {
  id         String   @id @default(cuid())
  workflowId String
  workflow    Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  name     String
  type     NodeType
  position Json
  data     Json @default("{}")

  outputConnections Connection[] @relation("FromNode")
  inputConnections  Connection[] @relation("ToNode")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([workflowId])
  @@map("node")
}

model Connection {
  id         String   @id @default(cuid())
  workflowId String
  workflow   Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  fromNodeId String
  fromNode   Node @relation("FromNode", fields: [fromNodeId], references: [id], onDelete: Cascade)
  toNodeId   String
  toNode     Node @relation("ToNode", fields: [toNodeId], references: [id], onDelete: Cascade)

  fromOutput String @default("main")
  toInput    String @default("main")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([fromNodeId, toNodeId, fromOutput, toInput])
  @@index([workflowId])
  @@map("connection")
}

enum ExecutionStatus {
  RUNNING
  SUCCESS
  FAILED
}

model Execution {
  id String @id @default(cuid())

  workflowId String
  workflow   Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  status     ExecutionStatus @default(RUNNING)
  error      String?         @db.Text
  errorStack String?         @db.Text

  startedAt  DateTime @default(now())
  completeAt DateTime?

  inngestEventId String @unique

  output Json?

  @@index([workflowId])
  @@map("execution")
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
}

model Invitation {
  id          String           @id @default(cuid())
  email       String
  workspaceId String
  role        MemberRole       @default(MEMBER)
  invitedById String
  status      InvitationStatus @default(PENDING)
  expiresAt   DateTime?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  invitedBy   User      @relation("SentInvitations", fields: [invitedById], references: [id], onDelete: Cascade)

  @@unique([email, workspaceId])
  @@index([email])
  @@index([workspaceId])
  @@map("invitation")
}

model TaskColumn {
  id          String    @id @default(cuid())
  workspaceId String
  name        String
  color       String    @default("#6B7280")
  position    Int
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  tasks       Task[]

  @@unique([workspaceId, position])
  @@index([workspaceId])
  @@map("task_column")
}

model Task {
  id          String    @id @default(cuid())
  workspaceId String
  columnId    String
  assigneeId  String?
  taskNumber  Int
  name        String
  description String?   @db.Text
  position    Int       @default(1000)
  dueDate     DateTime?
  startDate   DateTime?
  category    String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  reviewId    String?

  workspace   Workspace  @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  column      TaskColumn @relation(fields: [columnId], references: [id], onDelete: Cascade)
  assignee    User?      @relation(fields: [assigneeId], references: [id], onDelete: SetNull)
  review      Review?    @relation(fields: [reviewId], references: [id], onDelete: SetNull)

  @@unique([workspaceId, taskNumber])
  @@index([workspaceId])
  @@index([columnId])
  @@index([assigneeId])
  @@index([reviewId])
  @@map("task")
}

// =============================================
// SEO/GEO Report Tool
// =============================================

enum ReportStatus {
  PENDING
  FETCHING
  ANALYZING
  COMPLETED
  FAILED
}

model Report {
  id                    String       @id @default(cuid())
  workspaceId           String

  status                ReportStatus @default(PENDING)

  // Top-level scores (0-100)
  visibilityScore       Float?
  reputationScore       Float?

  // Detailed breakdowns (Zod-validated JSON)
  visibilityBreakdown   Json?
  reputationBreakdown   Json?

  // AI-generated insights (Zod-validated JSON)
  strengths             Json?
  weaknesses            Json?
  recommendations       Json?

  // Raw API response data (enables smart retry without re-fetching)
  rawData               Json?

  // Verification: did Outscraper match the workspace address?
  verification          Json?

  // Map pack competitors snapshot
  competitors           Json?

  error                 String?     @db.Text

  createdAt             DateTime    @default(now())
  completedAt           DateTime?

  workspace             Workspace   @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@index([workspaceId, createdAt])
  @@map("report")
}

// =============================================
// Reviews
// =============================================

model Review {
  id               String    @id @default(cuid())
  workspaceId      String
  workspace        Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  tasks            Task[]

  // Google identity (for dedup on re-scrape)
  googleReviewId   String?
  authorName       String?
  authorUrl        String?
  authorImageUrl   String?

  // Core review data
  rating           Float
  text             String?   @db.Text
  publishedAt      DateTime?

  // Owner response tracking
  ownerResponse    String?   @db.Text
  ownerRespondedAt DateTime?

  // Metadata
  source           String    @default("google") // google, yelp, facebook later
  language         String?

  // Sync tracking
  firstSeenAt      DateTime  @default(now())
  lastSyncedAt     DateTime  @default(now())

  // Performance indexes
  @@unique([workspaceId, googleReviewId]) // Prevents duplicate reviews
  @@index([workspaceId, publishedAt])     // Sort by date (paginated list)
  @@index([workspaceId, rating])          // Filter by star rating
  @@index([workspaceId, source])          // Filter by platform

  @@map("review")
}

// =============================================
// Chatbot System
// =============================================

model ChatBot {
  id              String    @id @default(cuid())
  domainId        String    @unique

  // Widget appearance
  welcomeMessage  String?   @default("Hey there, How can we assist?")
  icon            String?
  headerText      String?   @default("Sales Rep")
  themeColor      String?   @default("#14b8a6")

  // Behavior
  helpdesk        Boolean   @default(false)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  domain          Domain    @relation(fields: [domainId], references: [id], onDelete: Cascade)

  @@index([domainId])
  @@map("chatbot")
}

model HelpDeskItem {
  id              String    @id @default(cuid())
  domainId        String
  question        String
  answer          String    @db.Text

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  domain          Domain    @relation(fields: [domainId], references: [id], onDelete: Cascade)

  @@index([domainId])
  @@map("help_desk_item")
}

model FilterQuestion {
  id              String    @id @default(cuid())
  domainId        String
  question        String

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  domain          Domain    @relation(fields: [domainId], references: [id], onDelete: Cascade)
  responses       ChatContactResponse[]

  @@index([domainId])
  @@map("filter_question")
}

model ChatContact {
  id              String    @id @default(cuid())
  domainId        String
  workspaceId     String?
  email           String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  domain          Domain     @relation(fields: [domainId], references: [id], onDelete: Cascade)
  workspace       Workspace? @relation(fields: [workspaceId], references: [id], onDelete: SetNull)
  responses       ChatContactResponse[]
  chatRooms       ChatRoom[]

  @@index([domainId])
  @@index([workspaceId])
  @@index([domainId, email])
  @@map("chat_contact")
}

model ChatContactResponse {
  id              String    @id @default(cuid())
  contactId       String
  questionId      String
  answer          String?

  createdAt       DateTime  @default(now())

  contact         ChatContact    @relation(fields: [contactId], references: [id], onDelete: Cascade)
  question        FilterQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@index([contactId])
  @@index([questionId])
  @@map("chat_contact_response")
}

enum ChatMessageRole {
  USER
  ASSISTANT
}

model ChatRoom {
  id              String    @id @default(cuid())
  domainId        String
  workspaceId     String?
  contactId       String?

  live            Boolean   @default(false)
  mailed          Boolean   @default(false)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  domain          Domain       @relation(fields: [domainId], references: [id], onDelete: Cascade)
  workspace       Workspace?   @relation(fields: [workspaceId], references: [id], onDelete: SetNull)
  contact         ChatContact? @relation(fields: [contactId], references: [id], onDelete: SetNull)
  messages        ChatMessage[]

  @@index([domainId])
  @@index([workspaceId])
  @@index([contactId])
  @@index([domainId, createdAt])
  @@map("chat_room")
}

model ChatMessage {
  id              String          @id @default(cuid())
  chatRoomId      String
  message         String          @db.Text
  role            ChatMessageRole
  seen            Boolean         @default(false)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  chatRoom        ChatRoom  @relation(fields: [chatRoomId], references: [id], onDelete: Cascade)

  @@index([chatRoomId])
  @@index([chatRoomId, createdAt])
  @@map("chat_message")
}
